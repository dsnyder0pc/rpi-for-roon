#!/bin/bash
set -e # Exit immediately if a command exits with a non-zero status

# --- Usage Check ---
if [ -z "$1" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
  echo "Usage: $(basename "$0") <ImageFile> [SizeLimitGB]"
  echo "Example (8GB Limit):   $(basename "$0") my-image.img 8"
  echo "Example (Unlimited):   $(basename "$0") my-image.img"
  exit 1
fi

INPUT_FILE="$1"
SIZE_LIMIT_GB="$2"

# --- Calculate Target Sector (if limit provided) ---
TARGET_SECTOR=""
if [ -n "$SIZE_LIMIT_GB" ]; then
  # Validate integer
  if ! [[ "$SIZE_LIMIT_GB" =~ ^[0-9]+$ ]]; then
    echo "Error: Size limit must be an integer (e.g., 8)." >&2
    exit 1
  fi
  # 1 GiB = 1073741824 bytes
  # Sector = 512 bytes
  # Sectors per GiB = 2097152
  TARGET_SECTOR=$((SIZE_LIMIT_GB * 2097152))
  echo "âš ï¸  Partition limit active: ${SIZE_LIMIT_GB} GiB (Sector ${TARGET_SECTOR})"
else
  echo "ðŸš€ Partition limit: None (Will expand to fill disk)"
fi

# --- Dependency Check for pishrink.sh ---
if ! command -v pishrink.sh &> /dev/null; then
  echo "pishrink.sh not found. Attempting to install..."
  PISHRINK_URL="https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh"
  if curl -sL "${PISHRINK_URL}" | sudo install /dev/stdin /usr/local/bin/pishrink.sh; then
    echo "pishrink.sh installed successfully to /usr/local/bin."
  else
    echo "Failed to install pishrink.sh. Please install it manually." >&2
    exit 1
  fi
fi

# --- PHASE 1: Prepare Input File ---
WORK_FILE=""
echo "--- Checking input file type ---"
case "$INPUT_FILE" in
  *.xz)
    echo "XZ compressed image detected. Decompressing..."
    xz -dk "$INPUT_FILE"
    WORK_FILE="${INPUT_FILE%.xz}"
    ;;
  *.gz)
    echo "Gzip compressed image detected. Decompressing..."
    gunzip -k "$INPUT_FILE"
    WORK_FILE="${INPUT_FILE%.gz}"
    ;;
  *.bz2)
    echo "Bzip2 compressed image detected. Decompressing..."
    bunzip2 -k "$INPUT_FILE"
    WORK_FILE="${INPUT_FILE%.bz2}"
    ;;
  *.img)
    echo "Uncompressed image detected."
    WORK_FILE="$INPUT_FILE"
    ;;
  *)
    echo "Error: Unrecognized file type: $INPUT_FILE" >&2
    exit 1
    ;;
esac

echo "Working on: ${WORK_FILE}"

# --- PHASE 2: Modify the image inside a self-contained subshell ---
(
  MOUNT_POINT="/mnt/image_root"
  LOOP_DEVICE=""

  cleanup() {
    echo "--- Cleaning up modification phase ---"
    if mountpoint -q "${MOUNT_POINT}"; then
      sudo umount "${MOUNT_POINT}"
    fi
    if [ -n "${LOOP_DEVICE}" ]; then
      sudo losetup -d "${LOOP_DEVICE}"
    fi
  }
  trap cleanup EXIT

  echo "--- Modifying image ---"
  LOOP_DEVICE=$(sudo losetup -fP --show "${WORK_FILE}")
  ROOT_PARTITION="${LOOP_DEVICE}p2"

  sudo mkdir -p "${MOUNT_POINT}"
  sudo mount "${ROOT_PARTITION}" "${MOUNT_POINT}"

  # Inject the self-expanding service for Arch Linux
  echo "Installing one-shot resize service..."

  # Note: Variable expansion happens here before writing the file.
  # If TARGET_SECTOR is empty, fdisk gets a blank line (default).
  # If TARGET_SECTOR is set, fdisk gets the number.
  sudo tee "${MOUNT_POINT}/usr/local/sbin/resize-fs-once.sh" > /dev/null <<EOF
#!/bin/bash
fdisk /dev/mmcblk0 <<END
d
2
n
p
2

${TARGET_SECTOR}
N
w
END
partprobe /dev/mmcblk0
resize2fs /dev/mmcblk0p2
systemctl disable resize-fs-once.service
rm /etc/systemd/system/resize-fs-once.service
rm /usr/local/sbin/resize-fs-once.sh
rm -f /etc/rc.local
EOF

  # Create the service file
  sudo tee "${MOUNT_POINT}/etc/systemd/system/resize-fs-once.service" > /dev/null <<'EOF'
[Unit]
Description=Resize Root Filesystem Once
[Service]
Type=oneshot
ExecStart=/usr/local/sbin/resize-fs-once.sh
[Install]
WantedBy=multi-user.target
EOF

  sudo chmod +x "${MOUNT_POINT}/usr/local/sbin/resize-fs-once.sh"
  sudo ln -sf /etc/systemd/system/resize-fs-once.service "${MOUNT_POINT}/etc/systemd/system/multi-user.target.wants/resize-fs-once.service"

  # --- START OF CLEANUP SYNCHRONIZATION ---

  if [ -f "${MOUNT_POINT}/home/audiolinux/.ssh/authorized_keys" ]; then
    echo "Removing SSH public key..."
    sudo rm -fv "${MOUNT_POINT}/home/audiolinux/.ssh/authorized_keys"
  fi

  echo "Restoring default pacman mirrorlist..."
  MIRROR_FILE="${MOUNT_POINT}/etc/pacman.d/mirrorlist"
  DEFAULT_MIRROR="http://mirror.archlinuxarm.org/\$arch/\$repo"
  CUSTOM_MIRROR="http://ca.us.mirror.archlinuxarm.org/\$arch/\$repo"
  if [ -f "$MIRROR_FILE" ]; then
    sudo sed -i "s|# *Server = ${DEFAULT_MIRROR}|Server = ${DEFAULT_MIRROR}|" "$MIRROR_FILE"
    sudo sed -i "s|^Server = ${CUSTOM_MIRROR}|# Server = ${CUSTOM_MIRROR}|" "$MIRROR_FILE"
  fi

  if [ -f "${MOUNT_POINT}/etc/machine-id" ]; then
    echo "Removing existing machine-id..."
    sudo rm "${MOUNT_POINT}/etc/machine-id"
    sudo touch "${MOUNT_POINT}/etc/machine-id"
  fi

  echo "Removing Roon unique identifiers..."
  sudo rm -fv "${MOUNT_POINT}/var/roon/RoonBridge/Settings/unique_id"
  sudo rm -fv "${MOUNT_POINT}/var/roon/RAATServer/Settings/unique_id"
  sudo rm -fv "${MOUNT_POINT}"/var/roon/*/Settings/*.json
  sudo rm -fv "${MOUNT_POINT}/home/audiolinux/roon-ir-remote/.roon-token"

  echo "Removing AudioLinux Menu Configuration Data..."
  sudo tee "${MOUNT_POINT}/opt/configuration/data" <<EOT> /dev/null
EMAIL=
VERSION=
EOT
  sudo chmod 600 "${MOUNT_POINT}/opt/configuration/data"

  if [ -f "${MOUNT_POINT}/root/.bash_history" ]; then
    echo "Cleaning up root user's Bash history..."
    sudo truncate --size 0 "${MOUNT_POINT}/root/.bash_history"
  fi

  if [ -f "${MOUNT_POINT}/home/audiolinux/.bash_history" ]; then
    echo "Cleaning up audiolinux user's Bash history..."
    sudo truncate --size 0 "${MOUNT_POINT}/home/audiolinux/.bash_history"
  fi

  echo "Cleaning up audiolinux user's wget logs..."
  sudo sh -c "rm -fv ${MOUNT_POINT}/home/audiolinux/wget-log*"

  # --- END OF CLEANUP SYNCHRONIZATION ---

  if [ -d "${MOUNT_POINT}/opt/diretta-alsa-target" ]; then
    dl=$(find "${MOUNT_POINT}/opt/diretta-alsa-target" ! -name 'diretta*')
    if [ -n "${dl}" ]; then
      echo "- Diretta License File Found."
      sudo mv -v "${dl}" "${WORK_FILE%.img}"."$(basename "${dl}")"
    fi
  fi
)

# --- PHASE 3: Shrink the fully prepared and unmounted image ---
echo "--- Shrinking image ---"
sudo pishrink.sh "${WORK_FILE}"

echo "Image is now prepared and ready to be compressed."
