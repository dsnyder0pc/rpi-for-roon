#!/bin/bash

# ==============================================================================
#         Remote System Preparation & Shutdown Script (v4 - Simplified)
#
# Meant to be run with a command that first clears the calling user's history:
# history -c; rm -f ~/.bash_history; export HISTSIZE=0; curl -fsSL https://raw.githubusercontent.com/dsnyder0pc/rpi-for-roon/refs/heads/main/scripts/prepare_system | sudo bash
# ==============================================================================

# --- Configuration ---
TARGET_USER="audiolinux"
MIRRORLIST_PATH="/etc/pacman.d/mirrorlist"
DEFAULT_MIRROR="http://mirror.archlinuxarm.org/\$arch/\$repo"
CUSTOM_MIRROR="http://ca.us.mirror.archlinuxarm.org/\$arch/\$repo"

# --- Script Start ---

if [[ $EUID -ne 0 ]]; then
   echo "🛑 Error: This script must be run with root privileges."
   exit 1
fi

echo "🚀 Starting remote system preparation..."
echo "------------------------------------------------"

# Step 1: Remove personal SSH public key
SSH_KEYS_FILE="/home/$TARGET_USER/.ssh/authorized_keys"
echo "🔐 Removing SSH public key for user '$TARGET_USER'..."
if [ -f "$SSH_KEYS_FILE" ]; then
    rm -fv "$SSH_KEYS_FILE"
else
    echo "   - No authorized_keys file found. Skipping."
fi

# ---

# Step 2: Restore default pacman mirrorlist
echo "🌐 Restoring default pacman mirrorlist..."
if [ -f "$MIRRORLIST_PATH" ]; then
    sed -i "s|# *Server = ${DEFAULT_MIRROR}|Server = ${DEFAULT_MIRROR}|" "$MIRRORLIST_PATH"
    echo "   - Enabled default Geo-IP mirror."
    sed -i "s|^Server = ${CUSTOM_MIRROR}|# Server = ${CUSTOM_MIRROR}|" "$MIRRORLIST_PATH"
    echo "   - Disabled custom California mirror."
else
    echo "   - ⚠️  Warning: Mirrorlist file not found at '$MIRRORLIST_PATH'."
fi

echo "------------------------------------------------"

# Step 3: Remote Roon Unique Identifiers
echo "🧹 Removing Roon Bridge ID..."
rm -fv /var/roon/RoonBridge/Settings/unique_id
echo "🧹 Removing RAAT Server ID..."
rm -fv /var/roon/RAATServer/Settings/unique_id

echo "------------------------------------------------"

# Step 4: Clean up root's Bash history
echo "🧹 Cleaning up root user's Bash history..."
history -c
if [ -f "$HOME/.bash_history" ]; then
    cat /dev/null > "$HOME/.bash_history"
    echo "   - Cleared history file for user 'root'."
fi
export HISTSIZE=0
echo "   - History disabled for this session."
echo "------------------------------------------------"

# Step 5: Sync disks and power off the system
echo "✅ Preparation complete. System will power off in 3 seconds."
sleep 3
sync
echo "🔌 Powering off now. Goodbye!"
poweroff
