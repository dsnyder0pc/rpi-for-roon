#!/bin/bash

# A script to install and configure chrony on Arch Linux and its derivatives.
# This version includes a pre-sync step to avoid TLS errors on systems
# with an incorrect clock.

# --- Configuration ---
# Use the NTP pool project for a robust and distributed time source.
# You can change this to a specific pool for your region if desired.
# For example: pool us.pool.ntp.org iburst
NTP_SERVERS="pool pool.ntp.org iburst"

# --- Script Start ---

# 1. Check for Root Privileges
if [ "$EUID" -ne 0 ]; then
  echo "Please run this script as root or with sudo."
  exit 1
fi

echo "--- Synchronizing system clock (to prevent TLS errors) ---"
# 2. Set the time using systemd-timesyncd. This is crucial for systems
#    where the clock is wrong, as it prevents pacman from failing with
#    TLS certificate validation errors.
timedatectl set-ntp true
# Give it a moment to sync
sleep 3

echo "--- Installing chrony ---"
# 3. Install chrony using pacman
#    -Sy: Syncs repositories and installs the package. Does NOT upgrade the system.
#    --noconfirm: Skips all confirmation prompts.
pacman -Sy --noconfirm chrony
if [ $? -ne 0 ]; then
    echo "Error: Failed to install chrony. Aborting."
    exit 1
fi

echo "--- Configuring chrony ---"
# 4. Back up the original configuration file if it exists
if [ -f /etc/chrony.conf ]; then
  echo "Backing up existing /etc/chrony.conf to /etc/chrony.conf.bak"
  mv /etc/chrony.conf /etc/chrony.conf.bak
fi

# 5. Create a new chrony.conf
#    Using a heredoc (<<EOF) to write the configuration directly.
cat <<EOF > /etc/chrony.conf
# This file was generated by the chrony installer script.

# Use NTP servers from the pool.ntp.org project.
# 'iburst' sends a burst of packets on startup for faster initial sync.
$NTP_SERVERS

# Step the system clock immediately if the offset is greater than 1.0 second,
# but only for the first three clock updates.
makestep 1.0 3

# Enable kernel synchronization of the real-time clock (RTC).
# This is useful for saving the time to the hardware clock.
rtcsync

# Specify the directory for log files.
logdir /var/log/chrony
EOF

echo "New configuration written to /etc/chrony.conf"

echo "--- Starting and Enabling chrony service ---"
# 6. Enable and start the chronyd service with systemctl
systemctl enable --now chronyd
if [ $? -ne 0 ]; then
    echo "Error: Failed to start or enable the chronyd service."
    exit 1
fi

echo ""
echo "--- Verification ---"
echo "Chrony has been installed, configured, and started."
echo "It may take a minute to synchronize. You can check the status with:"
echo "  chronyc sources"
echo "  systemctl status chronyd"
echo ""
echo "Done!"
