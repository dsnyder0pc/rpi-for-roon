#!/bin/bash
#
# purist-mode: A script to optimize the system for critical listening by minimizing
#              background processes. It also updates /etc/motd with the current status.
#
# This script will invoke 'sudo' internally for commands requiring elevation.
#

# --- Configuration ---
NSSWITCH_CONF="/etc/nsswitch.conf"
BACKUP_FILE="${NSSWITCH_CONF}.purist-bak"
MOTD_FILE="/etc/motd"

# --- Functions ---

# Function to activate Purist Mode
activate_mode() {
    echo "🚀 Activating Purist Mode..."

    # Stop services, disable DNS, drop gateway...
    sudo systemctl stop chronyd &>/dev/null
    sudo systemctl stop argononed.service &>/dev/null
    sudo cp "$NSSWITCH_CONF" "$BACKUP_FILE"
    sudo sed -i -E 's/^(hosts:).*/\1 files myhostname/' "$NSSWITCH_CONF"
    sudo ip route del default &>/dev/null
    
    # Update the Message of the Day (MOTD)
    echo "  -> Updating login message..."
    # Use $'' to ensure bash interprets the escape codes for color
    MOTD_ACTIVE_MSG=$'\e[1;32m✅ Purist Mode is ACTIVE.\e[0m System optimized for the highest sound quality.'
    # If a status line already exists, replace it. Otherwise, append it.
    if sudo grep -q "Purist Mode is" "$MOTD_FILE"; then
        sudo sed -i "s/.*Purist Mode is.*/${MOTD_ACTIVE_MSG}/" "$MOTD_FILE"
    else
        echo -e "\n${MOTD_ACTIVE_MSG}" | sudo tee -a "$MOTD_FILE" > /dev/null
    fi
    echo "     Login message set to 'Purist Mode'."

    echo ""
    echo "✅ Purist Mode is ACTIVE."
}

# Function to revert changes
revert_mode() {
    # Add idempotency check
    if [ ! -f "$BACKUP_FILE" ]; then
        echo "✅ System is already in standard operation mode."
        exit 0
    fi

    echo "⏪ Reverting to Standard Mode..."

    # Restore network, DNS, and services...
    sudo systemctl restart systemd-networkd &>/dev/null
    sudo mv "$BACKUP_FILE" "$NSSWITCH_CONF"
    sudo systemctl start chronyd &>/dev/null
    sudo systemctl start argononed.service &>/dev/null

    # Update the MOTD with a cautionary message
    echo "  -> Updating login message..."
    # Use $'' to ensure bash interprets the escape codes for color
    MOTD_DISABLED_MSG=$'\e[1;33m⚠️ CAUTION: Purist Mode is DISABLED.\e[0m Background activity may impact sound quality.'
    # If a status line already exists, replace it. Otherwise, append it.
    if sudo grep -q "Purist Mode is" "$MOTD_FILE"; then
        sudo sed -i "s/.*Purist Mode is.*/${MOTD_DISABLED_MSG}/" "$MOTD_FILE"
    else
        echo -e "\n${MOTD_DISABLED_MSG}" | sudo tee -a "$MOTD_FILE" > /dev/null
    fi
    echo "     Login message set to 'Standard Mode'."

    echo ""
    echo "✅ Purist Mode DISABLED. System is in standard operation mode."
}

# --- Main Script Logic ---

# Check for `sudo` availability
if ! command -v sudo &> /dev/null; then
    echo "Error: 'sudo' command not found. This script requires sudo to run."
    exit 1
fi

# Check if we need sudo and prompt for password if we do.
if [ "$EUID" -ne 0 ]; then
    echo "This script requires sudo privileges. You may be prompted for a password."
    echo "(Note: The default sudo password for Audiolinux is 'audiolinux0')"
    sudo -v || exit 1 # Prompt for password now.
    while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
fi

# Parse arguments to decide whether to activate or revert
if [[ "$1" == "--revert" || "$1" == "-r" ]]; then
    revert_mode
else
    # Idempotency check for activation
    if [ -f "$BACKUP_FILE" ]; then
        echo "✅ Purist Mode is already active."
        exit 0
    fi
    activate_mode
fi

exit 0
